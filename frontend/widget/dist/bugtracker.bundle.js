!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.BugTracker=e():t.BugTracker=e()}(Object("undefined"!=typeof self?self:this),()=>(()=>{"use strict";var t,e={d:(t,n)=>{for(var s in n)e.o(n,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:n[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},n={};e.d(n,{default:()=>D}),function(t){t.ERROR="ERROR",t.ACTION="ACTION",t.NETWORK="NETWORK",t.PERFORMANCE="PERFORMANCE",t.CUSTOM="CUSTOM"}(t||(t={}));var s=function(t,e,n,s){return new(n||(n=Promise))(function(i,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(r,a)}c((s=s.apply(t,e||[])).next())})};class i{constructor(t,e){this.baseUrl=t.replace(/\/$/,""),this.projectId=e}sendEvents(e,n,i){return s(this,void 0,void 0,function*(){var s,i,o,r,a,c,l,d,u,h,g;const m=Number(n);if(Number.isNaN(m))throw new Error("Session ID must be numeric to send events to backend");let p=null;for(const n of e){const e=(n.message||"")+(n.stackTrace?": "+n.stackTrace:""),v=""===e?"":e,f=null!==(i=null===(s=n.customMetadata)||void 0===s?void 0:s.eventLogId)&&void 0!==i?i:null===(o=n.customMetadata)||void 0===o?void 0:o.eventId;let b;if(n.type===t.ERROR)b=null!==(r=n.message)&&void 0!==r?r:v;else if(n.type===t.ACTION){const t=n.customMetadata||{};b=t.method||t.action?`form: ${null!==(a=t.method)&&void 0!==a?a:""} ${null!==(c=t.action)&&void 0!==c?c:""}`.trim():t.href?`link: ${t.href}`:null!=f?f:v}else b=null!=f?f:v;const y={sessionId:m,type:n.type,name:n.name,log:b,stackTrace:null!==(l=n.stackTrace)&&void 0!==l?l:"",url:null!==(d=n.url)&&void 0!==d?d:window.location.href,element:null!==(h=null!==(u=n.customMetadata&&(n.customMetadata.elementId||n.customMetadata.element))&&void 0!==u?u:n.tagName)&&void 0!==h?h:"",timestamp:new Date(n.timestamp).toISOString(),metadata:Object.assign({fileName:null!==(g=n.fileName)&&void 0!==g?g:"",lineNumber:n.lineNumber?String(n.lineNumber):"",statusCode:n.statusCode?String(n.statusCode):""},n.customMetadata||{})},w=yield fetch(`${this.baseUrl}/api/events`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(y),keepalive:!0});if(p=w,!w.ok)throw new Error(`HTTP ${w.status}: ${yield w.text()}`)}return{success:!0,message:"Events sent",data:{sessionId:n,receivedCount:e.length,timestamp:(new Date).toISOString()}}})}sendEventsWithBeacon(e,n,s){var i,o,r,a,c,l,d,u,h,g,m;const p=Number(n);if(Number.isNaN(p))return!1;try{for(const n of e){const e=null!==(o=null===(i=n.customMetadata)||void 0===i?void 0:i.eventLogId)&&void 0!==o?o:null===(r=n.customMetadata)||void 0===r?void 0:r.eventId,s=(n.message||"")+(n.stackTrace?": "+n.stackTrace:""),v=""===s?"":s;let f;if(n.type===t.ERROR)f=null!==(a=n.message)&&void 0!==a?a:v;else if(n.type===t.ACTION){const t=n.customMetadata||{};f=t.method||t.action?`form: ${null!==(c=t.method)&&void 0!==c?c:""} ${null!==(l=t.action)&&void 0!==l?l:""}`.trim():t.href?`link: ${t.href}`:null!=e?e:v}else f=null!=e?e:v;const b={sessionId:p,type:n.type,name:n.name,log:f,stackTrace:null!==(d=n.stackTrace)&&void 0!==d?d:"",url:null!==(u=n.url)&&void 0!==u?u:window.location.href,element:null!==(g=null!==(h=n.customMetadata&&(n.customMetadata.elementId||n.customMetadata.element))&&void 0!==h?h:n.tagName)&&void 0!==g?g:"",timestamp:new Date(n.timestamp).toISOString(),metadata:Object.assign({fileName:null!==(m=n.fileName)&&void 0!==m?m:"",lineNumber:n.lineNumber?String(n.lineNumber):"",statusCode:n.statusCode?String(n.statusCode):""},n.customMetadata||{})},y=new Blob([JSON.stringify(b)],{type:"application/json"});navigator.sendBeacon(`${this.baseUrl}/api/events`,y)}return!0}catch(t){return!1}}sendBugReport(t,e,n){return s(this,void 0,void 0,function*(){const n=Number(e);if(Number.isNaN(n))throw new Error("Session ID must be numeric to send bug reports to backend");const s={projectId:this.projectId,sessionId:n,title:t.comment?t.comment.substring(0,80):"User report",tags:[],reportedAt:(new Date).toISOString(),comments:t.comment,userEmail:t.email,screen:t.screenshot,currentUrl:window.location.href,userProvided:!0},i=yield fetch(`${this.baseUrl}/api/reports/widget`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!i.ok)throw new Error(`HTTP ${i.status}: ${yield i.text()}`);return{success:!0,message:(yield i.json()).message||"Report created",data:{sessionId:e,receivedCount:1,timestamp:(new Date).toISOString()}}})}sendSessionStart(t,e){return s(this,void 0,void 0,function*(){const t={projectId:this.projectId,startTime:e.startTime,browser:e.browser,browserVersion:e.browserVersion,os:e.os,deviceType:e.deviceType,screenResolution:e.screenResolution,viewportSize:e.viewportSize,language:e.language,userAgent:e.userAgent,ipAddress:e.ipAddress,cookiesHash:e.cookiesHash,plugins:e.plugins};try{const e=yield fetch(`${this.baseUrl}/api/sessions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)return null;return(yield e.json()).sessionId}catch(t){return null}})}}class o{constructor(){this.prefix="bt_"}set(t,e){try{const n=this.prefix+t,s=JSON.stringify(e);localStorage.setItem(n,s)}catch(t){console.warn("Failed to save to localStorage:",t)}}get(t){try{const e=this.prefix+t,n=localStorage.getItem(e);return n?JSON.parse(n):null}catch(t){return console.warn("Failed to read from localStorage:",t),null}}remove(t){try{const e=this.prefix+t;localStorage.removeItem(e)}catch(t){console.warn("Failed to remove from localStorage:",t)}}clear(){try{const t=[];for(let e=0;e<localStorage.length;e++){const n=localStorage.key(e);n&&n.startsWith(this.prefix)&&t.push(n)}t.forEach(t=>localStorage.removeItem(t))}catch(t){console.warn("Failed to clear localStorage:",t)}}setSession(t){this.set("session",t)}getSession(){return this.get("session")}updateLastActivity(){const t=this.getSession();t&&(t.lastActivity=Date.now(),this.setSession(t))}static isAvailable(){try{const t="__bt_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(t){return!1}}}var r=function(t,e,n,s){return new(n||(n=Promise))(function(i,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(r,a)}c((s=s.apply(t,e||[])).next())})};const a="bt_server_session";class c{constructor(t=18e5,e){this.sessionId=0,this.serverSessionId=null,this.sessionData=null,this.lastActivity=Date.now(),this.cleanupTimer=null,this.storage=new o,this.sessionTimeout=t,this.client=e;try{const t=localStorage.getItem(a);if(t){const e=Number(t);Number.isNaN(e)||(this.serverSessionId=e)}}catch(t){}}initialize(){const t=this.getExistingSession();return t&&!this.isSessionExpired(t)?(this.sessionId=t.id,this.sessionData=t.data,this.lastActivity=t.lastActivity,this.updateLastActivity(),this.startCleanupTimer(),!this.serverSessionId&&this.client&&this.createServerSession(this.sessionId,this.sessionData).catch(()=>{}),this.sessionId):this.createNewSession()}createNewSession(){return this.sessionId=-Date.now(),this.lastActivity=Date.now(),this.sessionData=this.collectSessionData(),this.sessionData.active=!0,this.storage.set("bt_session",{id:this.sessionId,startTime:this.lastActivity,lastActivity:this.lastActivity,data:this.sessionData}),this.setupCrossTabSync(),this.startCleanupTimer(),this.client&&this.createServerSession(this.sessionId,this.sessionData).catch(t=>{}),this.sessionId}createServerSession(t,e){return r(this,void 0,void 0,function*(){try{console.debug("[SessionManager] attempting to create server session for local id",t);const n=yield this.client.sendSessionStart(String(t),e);null===n||Number.isNaN(Number(n))?console.debug("[SessionManager] server session creation returned null (possibly invalid projectId or network error)"):(this.setServerSessionId(Number(n)),console.debug("[SessionManager] server session created:",this.serverSessionId),this.sessionData&&(this.sessionData.id=Number(n)))}catch(t){return void console.debug("[SessionManager] createServerSession failed:",t)}})}collectSessionData(){const t=function(){const t=navigator.userAgent;let e="Unknown",n="Unknown";const s=Array.from(navigator.plugins).map(t=>t.name);if(t.includes("Chrome")&&!t.includes("Edg")){const s=t.match(/Chrome\/(\d+\.\d+)/);e="Chrome",n=s?s[1]:"Unknown"}else if(t.includes("Firefox")){const s=t.match(/Firefox\/(\d+\.\d+)/);e="Firefox",n=s?s[1]:"Unknown"}else if(t.includes("Safari")&&!t.includes("Chrome")){const s=t.match(/Version\/(\d+\.\d+)/);e="Safari",n=s?s[1]:"Unknown"}else if(t.includes("Edg")){const s=t.match(/Edg\/(\d+\.\d+)/);e="Edge",n=s?s[1]:"Unknown"}return{name:e,version:n,plugins:s}}(),e=function(){const t=navigator.userAgent;let e="Unknown";return t.includes("Windows")?e="Windows":t.includes("Mac")?e="macOS":t.includes("Linux")?e="Linux":t.includes("Android")?e="Android":(t.includes("iOS")||t.includes("iPhone")||t.includes("iPad"))&&(e="iOS"),{name:e}}(),n=function(){const t=navigator.userAgent;let e="desktop";return/Mobile|Android|iPhone|iPad|iPod/i.test(t)&&(e="mobile",/iPad/i.test(t)&&(e="tablet")),{type:e}}(),s=function(){const t=navigator.connection;let e="unknown";return t&&(e=t.effectiveType||"unknown"),{type:e}}();return{id:this.sessionId,startTime:(new Date).toISOString(),lastActivity:(new Date).toISOString(),active:!0,browser:t.name,browserVersion:t.version,os:e.name,plugins:t.plugins,screenResolution:`${window.screen.width}x${window.screen.height}`,viewportSize:`${window.innerWidth}x${window.innerHeight}`,cookiesHash:this.hashCookies(document.cookie),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,language:navigator.language,userAgent:navigator.userAgent,deviceType:n.type,connectionType:s.type,url:window.location.href,referrer:document.referrer}}hashCookies(t){let e=0;for(let n=0;n<t.length;n++){e=(e<<5)-e+t.charCodeAt(n),e&=e}return e.toString(36)}getExistingSession(){return this.storage.get("bt_session")}isSessionExpired(t){return Date.now()-t.lastActivity>this.sessionTimeout}updateLastActivity(){this.lastActivity=Date.now();const t=this.storage.get("bt_session");t&&(t.lastActivity=this.lastActivity,this.storage.set("bt_session",t)),this.resetCleanupTimer()}startCleanupTimer(){this.cleanupTimer&&clearInterval(this.cleanupTimer),this.cleanupTimer=window.setInterval(()=>{const t=this.getExistingSession();t&&this.isSessionExpired(t)&&(this.endSession(),this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null))},6e4)}resetCleanupTimer(){this.startCleanupTimer()}endSession(){try{this.storage.remove("bt_session")}catch(t){}this.sessionId=0,this.sessionData=null,this.serverSessionId=null;try{localStorage.removeItem(a)}catch(t){}this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null)}setupCrossTabSync(){window.addEventListener("storage",t=>{if("bt_session"===t.key&&t.newValue)try{const e=JSON.parse(t.newValue);e.startTime>this.lastActivity&&(this.sessionId=e.id,this.sessionData=e.data,this.lastActivity=e.lastActivity)}catch(t){}})}getSessionId(){var t;return null!==(t=this.serverSessionId)&&void 0!==t?t:this.sessionId}setServerSessionId(t){this.serverSessionId=Number(t);try{localStorage.setItem(a,String(this.serverSessionId))}catch(t){}this.sessionData&&(this.sessionData.id=Number(t))}isServerBacked(){return!!this.serverSessionId}getSessionData(){return this.sessionData||(console.warn("Session data accessed before initialization, creating now"),this.initialize()),this.sessionData}isActive(){return!!this.getSessionId()&&!this.isSessionExpired({lastActivity:this.lastActivity})}}var l=function(t,e,n,s){return new(n||(n=Promise))(function(i,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(r,a)}c((s=s.apply(t,e||[])).next())})};class d{constructor(t,e){this.buffer=[],this.maxSize=t,this.onFlush=e}add(t){this.buffer.push(t);("ACTION"===t.type||"ERROR"===t.type)&&this.flush().catch(()=>{}),this.buffer.length>=this.maxSize&&this.flush().catch(()=>{})}flush(){return l(this,void 0,void 0,function*(){if(0===this.buffer.length)return;const t=[...this.buffer];this.buffer=[];try{yield this.onFlush(t)}catch(e){throw this.buffer=[...t,...this.buffer],e}})}getEvents(){return[...this.buffer]}clear(){this.buffer=[]}get size(){return this.buffer.length}isEmpty(){return 0===this.buffer.length}isFull(){return this.buffer.length>=this.maxSize}hasUrgentEvents(){return this.buffer.some(t=>"ACTION"===t.type||"ERROR"===t.type)}}function u(t){const e=`${t.name}:${t.message}:${t.stack||""}`;let n=0;for(let t=0;t<e.length;t++){n=(n<<5)-n+e.charCodeAt(t),n&=n}return Math.abs(n).toString(36)}class h{constructor(t){this.isCapturing=!1,this.originalConsoleError=null,this.ignoredErrors=[],this.onError=t}start(){this.isCapturing||(window.addEventListener("error",this.handleWindowError.bind(this)),window.addEventListener("unhandledrejection",this.handleUnhandledRejection.bind(this)),this.isCapturing=!0)}stop(){this.isCapturing&&(window.removeEventListener("error",this.handleWindowError),window.removeEventListener("unhandledrejection",this.handleUnhandledRejection),this.originalConsoleError&&(console.error=this.originalConsoleError,this.originalConsoleError=null),this.isCapturing=!1)}enableConsoleErrors(){this.originalConsoleError||(this.originalConsoleError=console.error,console.error=(...t)=>{var e;let n;if(null===(e=this.originalConsoleError)||void 0===e||e.apply(console,t),t[0]instanceof Error)n=t[0];else{const e=t.map(t=>"object"==typeof t?JSON.stringify(t):String(t)).join(" ");n=new Error(e),n.name="ConsoleError"}this.onError(n,{type:"console",reason:t})})}disableConsoleErrors(){this.originalConsoleError&&(console.error=this.originalConsoleError,this.originalConsoleError=null)}ignoreErrors(t){this.ignoredErrors=[...this.ignoredErrors,...t]}shouldIgnoreError(t){if(!this.ignoredErrors.length)return!1;const e=`${t.name}: ${t.message}`;return this.ignoredErrors.some(n=>e.includes(n)||t.stack&&t.stack.includes(n))}handleWindowError(t){if(t.filename&&!t.filename.startsWith(window.location.origin))return;let e;t.error?e=t.error:(e=new Error(t.message),e.name="WindowError",e.stack=`at ${t.filename}:${t.lineno}:${t.colno}`),e.fingerprint=u(e),this.shouldIgnoreError(e)||this.onError(e,{type:"window",event:t})}handleUnhandledRejection(t){let e;if(t.reason instanceof Error)e=t.reason;else{const n="string"==typeof t.reason?t.reason:JSON.stringify(t.reason);e=new Error(`Unhandled Promise Rejection: ${n}`),e.name="UnhandledRejection"}e.fingerprint=u(e),this.shouldIgnoreError(e)||this.onError(e,{type:"promise",reason:t.reason})}captureError(t,e){const n=new Error(t.message);n.name=t.name,n.stack=t.stack,n.fingerprint=u(t),n.customMetadata=e,this.onError(n,{type:"window",event:void 0})}isActive(){return this.isCapturing}getIgnoredErrors(){return[...this.ignoredErrors]}clearIgnoredErrors(){this.ignoredErrors=[]}}var g=function(t,e,n,s){return new(n||(n=Promise))(function(i,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(r,a)}c((s=s.apply(t,e||[])).next())})};class m{constructor(t){this.isMonitoring=!1,this.trackSuccessfulRequests=!1,this.trackTimeout=1e4,this.ignoredUrls=[],this.onError=t,this.originalFetch=window.fetch,this.originalXMLHttpRequest=window.XMLHttpRequest,this.originalXHRPrototype=XMLHttpRequest.prototype}start(){this.isMonitoring||(this.patchFetch(),this.patchXMLHttpRequest(),this.isMonitoring=!0)}stop(){this.isMonitoring&&(window.fetch=this.originalFetch,window.XMLHttpRequest=this.originalXMLHttpRequest,this.isMonitoring=!1)}configure(t){void 0!==t.trackSuccessfulRequests&&(this.trackSuccessfulRequests=t.trackSuccessfulRequests),void 0!==t.trackTimeout&&(this.trackTimeout=t.trackTimeout),void 0!==t.ignoredUrls&&(this.ignoredUrls=t.ignoredUrls)}shouldIgnoreUrl(t){return this.ignoredUrls.some(e=>e.test(t))}patchFetch(){const t=this;window.fetch=function(...e){return g(this,void 0,void 0,function*(){const n=performance.now(),s=e[0],i=e[1]||{};let o,r="GET",a=null;if("string"==typeof s?o=s:s instanceof Request?(o=s.url,r=s.method):o=String(s),t.shouldIgnoreUrl(o))return t.originalFetch.apply(window,e);i.body&&(a=i.body),r=i.method||r;try{const s=yield t.originalFetch.apply(window,e),i=performance.now()-n;if(!s.ok){let e=null;try{const t=s.clone(),n=s.headers.get("content-type");e=n&&n.includes("application/json")?yield t.json():yield t.text()}catch(t){}t.onError({type:"fetch",url:o,method:r,status:s.status,statusText:s.statusText,duration:i,responseBody:e})}return t.trackSuccessfulRequests&&i>t.trackTimeout&&t.onError({type:"fetch",url:o,method:r,status:s.status,statusText:"Timeout",duration:i,error:new Error(`Request took ${i.toFixed(0)}ms`)}),s}catch(e){const s=performance.now()-n;throw t.onError({type:"fetch",url:o,method:r,status:0,statusText:"Network Error",duration:s,error:e,requestBody:a}),e}})}}patchXMLHttpRequest(){const t=this,e=this.originalXMLHttpRequest;window.XMLHttpRequest=class extends e{constructor(){super(...arguments),this._url="",this._method="GET",this._startTime=0,this._requestBody=null,this._responseBody=null}open(e,n,...s){this._method=e,this._url=n.toString(),this._startTime=performance.now(),t.shouldIgnoreUrl(this._url)||(this.addEventListener("error",this.handleError.bind(this)),this.addEventListener("load",this.handleLoad.bind(this)),this.addEventListener("timeout",this.handleTimeout.bind(this)),this.addEventListener("abort",this.handleAbort.bind(this))),super.open.apply(this,[e,n,...s])}send(t){this._requestBody=t,super.send(t)}handleError(){const e=performance.now()-this._startTime;t.onError({type:"xhr",url:this._url,method:this._method,status:this.status,statusText:this.statusText,duration:e,error:new Error("XHR Network Error"),requestBody:this._requestBody,responseBody:this._responseBody})}handleLoad(){const e=performance.now()-this._startTime;if(this.status>=400){try{""===this.responseType||"text"===this.responseType?this._responseBody=this.responseText:"json"===this.responseType&&(this._responseBody=this.response)}catch(t){}t.onError({type:"xhr",url:this._url,method:this._method,status:this.status,statusText:this.statusText,duration:e,requestBody:this._requestBody,responseBody:this._responseBody})}t.trackSuccessfulRequests&&e>t.trackTimeout&&t.onError({type:"xhr",url:this._url,method:this._method,status:this.status,statusText:"Timeout",duration:e,error:new Error(`Request took ${e.toFixed(0)}ms`)})}handleTimeout(){const e=performance.now()-this._startTime;t.onError({type:"xhr",url:this._url,method:this._method,status:408,statusText:"Request Timeout",duration:e,error:new Error("XHR Request Timeout"),requestBody:this._requestBody})}handleAbort(){const e=performance.now()-this._startTime;t.onError({type:"xhr",url:this._url,method:this._method,status:0,statusText:"Request Aborted",duration:e,error:new Error("XHR Request Aborted"),requestBody:this._requestBody})}}}isActive(){return this.isMonitoring}getConfig(){return{trackSuccessfulRequests:this.trackSuccessfulRequests,trackTimeout:this.trackTimeout,ignoredUrls:this.ignoredUrls}}}function p(t){var e;if(!t||!t.ownerDocument)return"";if(t.id)return`//*[@id="${t.id}"]`;const n=[];let s=t;for(;s&&s.nodeType===Node.ELEMENT_NODE;){let t=0;const i=(null===(e=s.parentNode)||void 0===e?void 0:e.children)||[];for(let e=0;e<i.length;e++){const o=i[e];if(o===s){const e=s.tagName.toLowerCase();n.unshift(`${e}[${t+1}]`);break}o.tagName===s.tagName&&t++}s=s.parentElement}return n.length>0?`/${n.join("/")}`:""}function v(t,e=200){var n;if(!t)return"";const s=(null===(n=t.textContent)||void 0===n?void 0:n.trim())||"";return s.length<=e?s:s.substring(0,e)+"..."}function f(t){if(["A","BUTTON","INPUT","SELECT","TEXTAREA","LABEL"].includes(t.tagName))return!0;const e=t.getAttribute("role");return!(!e||!["button","link","menuitem","tab","checkbox","radio"].includes(e))||(!!(t.hasAttribute("onclick")||t.hasAttribute("onchange")||t.hasAttribute("onsubmit"))||!!(t.hasAttribute("data-track")||t.hasAttribute("data-testid")||t.hasAttribute("data-qa")))}function b(t,e){let n=0,s=null;return function(...i){const o=Date.now(),r=e-(o-n);r<=0?(n=o,t.apply(this,i)):s||(s=window.setTimeout(()=>{n=Date.now(),t.apply(this,i),s=null},r))}}class y{constructor(t){this.isTracking=!1,this.ignoredActions=[],this.trackedElements=new Set,this.throttleDelay=100,this.onAction=t}start(){if(this.isTracking)return;const t=b(this.handleClick.bind(this),this.throttleDelay),e=b(this.handleSubmit.bind(this),this.throttleDelay),n=b(this.handleChange.bind(this),this.throttleDelay),s=b(this.handleKeydown.bind(this),this.throttleDelay);document.addEventListener("click",t,{capture:!0,passive:!0}),document.addEventListener("submit",e,{capture:!0}),document.addEventListener("change",n,{capture:!0}),document.addEventListener("keydown",s,{capture:!0}),this.trackNavigation(),this.isTracking=!0}stop(){this.isTracking&&(document.removeEventListener("click",this.handleClick),document.removeEventListener("submit",this.handleSubmit),document.removeEventListener("change",this.handleChange),document.removeEventListener("keydown",this.handleKeydown),this.isTracking=!1)}configure(t){t.ignoredActions&&(this.ignoredActions=t.ignoredActions),void 0!==t.throttleDelay&&(this.throttleDelay=t.throttleDelay)}shouldIgnoreAction(t,e){if(this.ignoredActions.includes(e))return!0;if(t.hasAttribute("data-bt-ignore"))return!0;const n=t.tagName.toLowerCase();return!!["script","style","link","meta"].includes(n)||("html"===n||"body"===n)}handleClick(t){const e=t.target;if(!e)return;const n=function(t){let e=t;for(;e;){if(f(e))return e;e=e.parentElement}return null}(e)||e;if(this.shouldIgnoreAction(n,"click"))return;const s=`${n.tagName}-${n.id||n.className}`;this.trackedElements.has(s)||(this.trackedElements.add(s),setTimeout(()=>this.trackedElements.delete(s),1e3),this.onAction({type:"click",element:n,target:e,event:t,metadata:{xPath:p(n),text:v(n,100),tagName:n.tagName,id:n.id||void 0,className:n.className||void 0,href:n.href||void 0,coordinates:{x:t.clientX,y:t.clientY},url:window.location.href}}))}handleSubmit(t){const e=t.target;e&&(this.shouldIgnoreAction(e,"submit")||this.onAction({type:"submit",element:e,target:e,event:t,metadata:{xPath:p(e),text:v(e,100),tagName:e.tagName,id:e.id||void 0,className:e.className||void 0,action:e.action,method:e.method,url:window.location.href}}))}handleChange(t){const e=t.target;if(!e)return;const n=e.type;["text","email","password","search","tel","url","number"].includes(n)&&(this.shouldIgnoreAction(e,"change")||this.onAction({type:"change",element:e,target:e,value:e.value,event:t,metadata:{xPath:p(e),text:v(e,50),tagName:e.tagName,id:e.id||void 0,className:e.className||void 0,type:n,name:e.name||void 0,value:e.value.substring(0,100),url:window.location.href}}))}handleKeydown(t){if(!["Enter","Escape","Tab"].includes(t.key))return;const e=t.target;e&&(this.shouldIgnoreAction(e,"keydown")||this.onAction({type:"keydown",element:e,target:e,event:t,metadata:{xPath:p(e),text:v(e,50),tagName:e.tagName,id:e.id||void 0,className:e.className||void 0,key:t.key,code:t.code,url:window.location.href}}))}trackNavigation(){const t=history.pushState,e=history.replaceState,n=t=>{this.onAction({type:"navigation",element:document.body,target:document.body,event:new Event(t),metadata:{xPath:"/html/body",text:"",tagName:"BODY",url:window.location.href,navigationType:t,referrer:document.referrer}})};history.pushState=function(...e){t.apply(this,e),n("pushstate")},history.replaceState=function(...t){e.apply(this,t),n("replacestate")},window.addEventListener("popstate",()=>{this.onAction({type:"navigation",element:document.body,target:document.body,event:new Event("popstate"),metadata:{xPath:"/html/body",text:"",tagName:"BODY",url:window.location.href,navigationType:"popstate",referrer:document.referrer}})})}trackManualAction(t,e,n){this.onAction({type:t,element:e,target:e,event:new Event("manual"),metadata:Object.assign({xPath:p(e),text:v(e,100),tagName:e.tagName,id:e.id||void 0,className:e.className||void 0,url:window.location.href},n)})}isActive(){return this.isTracking}getConfig(){return{ignoredActions:this.ignoredActions,throttleDelay:this.throttleDelay}}}class w{constructor(t="bottom-right",e,n="Report Bug"){this.button=null,this.isVisible=!0,this.position=t,this.onClick=e,this.text=n,this.styles={base:{position:"fixed",zIndex:"2147483647",padding:"12px 24px",backgroundColor:"#e74c3c",color:"white",border:"none",borderRadius:"25px",cursor:"pointer",fontSize:"14px",fontWeight:"600",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",outline:"none",userSelect:"none",touchAction:"manipulation",backdropFilter:"blur(10px)",borderWidth:"1px",borderStyle:"solid",borderColor:"rgba(255, 255, 255, 0.2)"},hover:{backgroundColor:"#c0392b",transform:"translateY(-2px)",boxShadow:"0 6px 20px rgba(0, 0, 0, 0.2)"},active:{backgroundColor:"#a93226",transform:"translateY(0)",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.15)"}}}create(){if(!this.button){if(this.button=document.createElement("button"),this.button.id="bugtracker-widget-button",this.button.innerHTML=this.text,this.button.title="Report a bug or issue",this.button.setAttribute("aria-label","Report a bug"),this.button.setAttribute("role","button"),this.applyStyles(this.styles.base),this.applyPosition(),this.addEventListeners(),!document.body){const t=()=>{try{document.body.appendChild(this.button),this.addGlobalStyles()}catch(t){console.error("WidgetButton: failed to append button after DOMContentLoaded",t),this.button=null}};return void("loading"===document.readyState?document.addEventListener("DOMContentLoaded",t,{once:!0}):setTimeout(t,0))}document.body.appendChild(this.button),this.addGlobalStyles()}}applyStyles(t){this.button&&Object.assign(this.button.style,t)}applyPosition(){if(!this.button)return;Object.assign(this.button.style,{"top-left":{top:"20px",left:"20px"},"top-right":{top:"20px",right:"20px"},"bottom-left":{bottom:"20px",left:"20px"},"bottom-right":{bottom:"20px",right:"20px"}}[this.position])}addEventListeners(){this.button&&(this.button.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.onClick()}),this.button.addEventListener("mouseenter",()=>{this.applyStyles(this.styles.hover)}),this.button.addEventListener("mouseleave",()=>{this.applyStyles(this.styles.base)}),this.button.addEventListener("mousedown",()=>{this.applyStyles(this.styles.active)}),this.button.addEventListener("mouseup",()=>{this.applyStyles(this.styles.hover)}),this.button.addEventListener("touchstart",()=>{this.applyStyles(this.styles.active)},{passive:!0}),this.button.addEventListener("touchend",()=>{this.applyStyles(this.styles.base)},{passive:!0}),this.button.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),this.onClick())}))}addGlobalStyles(){const t="bugtracker-widget-styles";if(document.getElementById(t))return;const e=document.createElement("style");e.id=t,e.textContent="\n            #bugtracker-widget-button {\n                animation: bugtracker-button-appear 0.3s ease;\n            }\n            @keyframes bugtracker-button-appear {\n                from { opacity: 0; transform: translateY(20px) scale(0.9); }\n                to { opacity: 1; transform: translateY(0) scale(1); }\n            }\n            @media (prefers-reduced-motion: reduce) {\n                #bugtracker-widget-button { animation: none; transition: none; }\n            }\n        ";const n=document.head||document.documentElement||document.body;try{n.appendChild(e)}catch(t){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{(document.head||document.documentElement||document.body).appendChild(e)},{once:!0}):console.error("WidgetButton: failed to append global styles",t)}}show(){this.button&&(this.button.style.display="block",this.button.style.visibility="visible",this.button.style.opacity="1",this.isVisible=!0)}hide(){this.button&&(this.button.style.display="none",this.isVisible=!1)}toggle(){this.isVisible?this.hide():this.show()}setText(t){this.text=t,this.button&&(this.button.innerHTML=t)}setPosition(t){this.position=t,this.button&&this.applyPosition()}updateStyles(t){t.base&&(this.styles.base=Object.assign(Object.assign({},this.styles.base),t.base)),t.hover&&(this.styles.hover=Object.assign(Object.assign({},this.styles.hover),t.hover)),t.active&&(this.styles.active=Object.assign(Object.assign({},this.styles.active),t.active)),this.button&&this.applyStyles(this.styles.base)}destroy(){if(!this.button)return;this.button.parentNode&&this.button.parentNode.removeChild(this.button);const t=document.getElementById("bugtracker-widget-styles");t&&t.parentNode&&t.parentNode.removeChild(t),this.button=null}exists(){return null!==this.button}isButtonVisible(){return this.isVisible}getButtonElement(){return this.button}}var S=function(t,e,n,s){return new(n||(n=Promise))(function(i,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(r,a)}c((s=s.apply(t,e||[])).next())})};class k{constructor(){this.html2canvas=null,this.defaultOptions={},this.cdnUrl="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js",this.loadingPromise=null,this.setDefaultOptions(),this.checkAvailability()}setDefaultOptions(){this.defaultOptions={scale:.8,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",logging:!1,imageTimeout:15e3,removeContainer:!0,onclone:null}}checkAvailability(){"undefined"!=typeof window&&window.html2canvas&&(this.html2canvas=window.html2canvas)}ensureHtml2Canvas(){return S(this,void 0,void 0,function*(){if(!this.html2canvas&&(this.checkAvailability(),!this.html2canvas))return this.loadingPromise||(this.loadingPromise=new Promise((t,e)=>{const n=document.querySelector(`script[src="${this.cdnUrl}"]`);if(n){const s=()=>{this.checkAvailability(),this.html2canvas?t():e(new Error("html2canvas not available after load"))};return window.html2canvas?(this.html2canvas=window.html2canvas,void t()):(n.addEventListener("load",s,{once:!0}),void n.addEventListener("error",()=>e(new Error("Failed to load html2canvas")),{once:!0}))}const s=document.createElement("script");s.src=this.cdnUrl,s.async=!0,s.onload=()=>{this.checkAvailability(),this.html2canvas?t():e(new Error("html2canvas did not expose expected API"))},s.onerror=()=>e(new Error("Failed to load html2canvas script")),document.head.appendChild(s)})),this.loadingPromise})}isHtml2CanvasAvailable(){return!!this.html2canvas||!("undefined"==typeof window||!window.html2canvas)}setOptions(t){this.defaultOptions=Object.assign(Object.assign({},this.defaultOptions),t)}getOptions(){return Object.assign({},this.defaultOptions)}capture(t,e){return S(this,void 0,void 0,function*(){if(yield this.ensureHtml2Canvas(),!this.html2canvas&&!window.html2canvas)throw new Error("html2canvas is not available");const n=this.html2canvas||window.html2canvas,s=Object.assign(Object.assign({},this.defaultOptions),e);return(yield n(t,s)).toDataURL("image/jpeg",.8)})}capturePreview(t){return S(this,void 0,void 0,function*(){const e=t||document.body,n=Object.assign(Object.assign({},this.defaultOptions),{scale:.3,quality:.5,backgroundColor:null});return this.capture(e,n)})}captureFinal(t){return S(this,void 0,void 0,function*(){const e=t||document.body,n=Object.assign(Object.assign({},this.defaultOptions),{scale:.8,quality:.8,backgroundColor:"#ffffff"});try{return yield this.capture(e,n)}catch(t){const e=Object.assign(Object.assign({},this.defaultOptions),{width:window.innerWidth,height:window.innerHeight,x:window.pageXOffset,y:window.pageYOffset});yield this.ensureHtml2Canvas();const n=this.html2canvas||window.html2canvas;return(yield n(document.body,e)).toDataURL("image/jpeg",.8)}})}captureViewport(){return S(this,void 0,void 0,function*(){const t=Object.assign(Object.assign({},this.defaultOptions),{width:window.innerWidth,height:window.innerHeight,x:window.pageXOffset,y:window.pageYOffset});yield this.ensureHtml2Canvas();const e=this.html2canvas||window.html2canvas;return(yield e(document.body,t)).toDataURL("image/jpeg",.8)})}dataUrlToBlob(t){return S(this,void 0,void 0,function*(){return new Promise(e=>{var n;try{const s=t.split(","),i=(null===(n=s[0].match(/:(.*?);/))||void 0===n?void 0:n[1])||"image/jpeg",o=atob(s[1]);let r=o.length;const a=new Uint8Array(r);for(;r--;)a[r]=o.charCodeAt(r);e(new Blob([a],{type:i}))}catch(t){console.error("Failed to convert data URL to Blob:",t),e(null)}})})}}var E=function(t,e,n,s){return new(n||(n=Promise))(function(i,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(r,a)}c((s=s.apply(t,e||[])).next())})};class T{constructor(t,e,n,s){this.modal=null,this.content=null,this.screenshotData=null,this.screenshotAllowed=!1,this.rememberConsentKey="bt_screenshot_allowed",this.beaconClient=t,this.projectId=e,this.sessionId=n,this.onClose=s,this.screenshotCapturer=new k}open(){return E(this,void 0,void 0,function*(){if(!this.modal){this.modal=this.createModal(),document.body.appendChild(this.modal);try{"1"===sessionStorage.getItem(this.rememberConsentKey)&&(this.screenshotAllowed=!0)}catch(t){}yield this.capturePreview()}})}close(){this.modal&&this.modal.parentNode&&(this.modal.parentNode.removeChild(this.modal),this.modal=null,this.content=null),this.onClose()}createModal(){const t=document.createElement("div");return t.className="bugtracker-modal-overlay",t.innerHTML=this.getModalHTML(),this.applyStyles(t),this.attachEventListeners(t),t}capturePreview(t){return E(this,void 0,void 0,function*(){var e,n,s;const i=t||(null===(e=this.content)||void 0===e?void 0:e.querySelector("#bugtracker-screenshot-preview"))||document.body;try{const t=yield this.screenshotCapturer.capturePreview(i);return this.updatePreviewElement(null===(n=this.content)||void 0===n?void 0:n.querySelector("#bugtracker-screenshot-preview"),t),this.screenshotData=t,t}catch(t){throw this.showPreviewError(null===(s=this.content)||void 0===s?void 0:s.querySelector("#bugtracker-screenshot-preview"),t),t}})}submitReport(){return E(this,void 0,void 0,function*(){var t,e,n;const s=null===(t=this.content)||void 0===t?void 0:t.querySelector(".bugtracker-modal-submit"),i=null===(e=this.content)||void 0===e?void 0:e.querySelector("#bugtracker-comment"),o=null===(n=this.content)||void 0===n?void 0:n.querySelector("#bugtracker-email");if(!s||!i)return;const r=i.value.trim();if(!r)return void this.showError("Please describe what went wrong");if(r.length>1e3)return void this.showError("Description must be less than 1000 characters");s.disabled=!0;const a=s.innerHTML;s.innerHTML='\n        <div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px; margin-right: 6px;"></div>\n        Submitting...\n    ';try{let t=this.screenshotData;if(!t&&this.screenshotAllowed)try{t=yield this.screenshotCapturer.captureFinal()}catch(t){console.warn("Failed to capture final screenshot:",t)}let e=null;t&&(e=yield this.screenshotCapturer.dataUrlToBlob(t));const n={projectId:this.projectId,sessionId:this.sessionId,title:r.substring(0,100),tags:[],reportedAt:(new Date).toISOString(),comments:r,userEmail:(null==o?void 0:o.value.trim())||null,currentUrl:window.location.href,userProvided:!0};if(!(yield this.beaconClient.sendBugReportMultipart(n,e)))throw new Error("Failed to submit report");this.close()}catch(t){console.error("Failed to submit bug report:",t),this.showError("Failed to submit report. Please try again.")}finally{s.disabled=!1,s.innerHTML=a}})}captureScreenshot(){return E(this,void 0,void 0,function*(){var t;const e=null===(t=this.content)||void 0===t?void 0:t.querySelector("#bugtracker-screenshot-preview");if(e)try{this.screenshotData=yield this.screenshotCapturer.capturePreview(e),this.updatePreviewElement(e,this.screenshotData)}catch(t){console.error("Failed to capture screenshot:",t),this.showScreenshotError(e,t)}})}getModalHTML(){return'\n        <div class="bugtracker-modal">\n            <div class="bugtracker-modal-content">\n                <button class="bugtracker-modal-close" aria-label="Close">&times;</button>\n                <h2>Report a bug</h2>\n                <div id="bugtracker-screenshot-area">\n                    <div id="bugtracker-screenshot-preview" class="bugtracker-screenshot-placeholder">No screenshot</div>\n                    <div style="margin-top:8px;">\n                        <button id="bugtracker-capture-btn" type="button">Capture Screenshot</button>\n                    </div>\n                    <div id="bugtracker-screenshot-consent" style="display:none;margin-top:8px;padding:8px;border-radius:4px;background:#f9f9f9;">\n                        <div style="margin-bottom:6px;">Do you allow taking a screenshot of your browser window for this bug report? This will capture visible content only.</div>\n                        <label style="display:flex;align-items:center;gap:6px;margin-bottom:6px;"><input type="checkbox" id="bugtracker-remember-consent" /> Remember my choice for this session</label>\n                        <div>\n                            <button id="bugtracker-allow-screenshot" type="button" style="margin-right:8px;">Allow</button>\n                            <button id="bugtracker-deny-screenshot" type="button">Deny</button>\n                        </div>\n                        <div id="bugtracker-screenshot-consent-error" style="display:none;color:#c62828;margin-top:6px;font-size:12px;"></div>\n                    </div>\n                </div>\n                <textarea id="bugtracker-comment" placeholder="Describe what happened" rows="6"></textarea>\n                <input id="bugtracker-email" placeholder="Your email (optional)" type="email" />\n                <div class="bugtracker-error" style="display:none;color:#c62828;margin-top:8px;"></div>\n                <div style="margin-top:12px;">\n                    <button class="bugtracker-modal-submit">Submit Report</button>\n                </div>\n            </div>\n        </div>\n        '}applyStyles(t){const e=document.createElement("style");e.textContent='\n        .bugtracker-modal-overlay {\n            position: fixed;\n            inset: 0;\n            background: rgba(0,0,0,0.45);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 99999;\n        }\n        .bugtracker-modal { max-width: 720px; width: 92%; }\n        .bugtracker-modal-content {\n            background: #fff;\n            border-radius: 8px;\n            padding: 16px;\n            box-shadow: 0 8px 24px rgba(0,0,0,0.2);\n            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;\n        }\n        .bugtracker-modal-close {\n            float: right;\n            background: transparent;\n            border: none;\n            font-size: 20px;\n            cursor: pointer;\n        }\n        #bugtracker-screenshot-preview {\n            width: 100%;\n            height: 160px;\n            background: #f4f4f4;\n            display:flex;\n            align-items:center;\n            justify-content:center;\n            overflow:hidden;\n            border-radius:4px;\n        }\n        #bugtracker-screenshot-preview img { max-width:100%; max-height:100%; display:block; }\n        #bugtracker-comment { width:100%; margin-top:8px; box-sizing:border-box; }\n        #bugtracker-email { width:100%; margin-top:8px; box-sizing:border-box; padding:6px; }\n        .bugtracker-modal-submit { margin-top:8px; padding:8px 12px; cursor:pointer; }\n        ',t.appendChild(e)}attachEventListeners(t){var e,n,s,i,o,r;this.content=t.querySelector(".bugtracker-modal-content");const a=null===(e=this.content)||void 0===e?void 0:e.querySelector(".bugtracker-modal-close");null==a||a.addEventListener("click",()=>this.close());const c=null===(n=this.content)||void 0===n?void 0:n.querySelector(".bugtracker-modal-submit");null==c||c.addEventListener("click",t=>{t.preventDefault(),this.submitReport()});const l=null===(s=this.content)||void 0===s?void 0:s.querySelector("#bugtracker-capture-btn");null==l||l.addEventListener("click",t=>E(this,void 0,void 0,function*(){t.preventDefault(),yield this.requestConsentAndCapture()}));const d=null===(i=this.content)||void 0===i?void 0:i.querySelector("#bugtracker-allow-screenshot");null==d||d.addEventListener("click",t=>E(this,void 0,void 0,function*(){t.preventDefault(),yield this.handleAllowConsent()}));const u=null===(o=this.content)||void 0===o?void 0:o.querySelector("#bugtracker-deny-screenshot");null==u||u.addEventListener("click",t=>{t.preventDefault(),this.handleDenyConsent()});const h=null===(r=this.content)||void 0===r?void 0:r.querySelector("#bugtracker-screenshot-preview");null==h||h.addEventListener("click",()=>E(this,void 0,void 0,function*(){yield this.requestConsentAndCapture()})),t.addEventListener("click",e=>{e.target===t&&this.close()})}requestConsentAndCapture(){return E(this,void 0,void 0,function*(){var t;if(this.screenshotAllowed)return void(yield this.captureScreenshot());const e=null===(t=this.content)||void 0===t?void 0:t.querySelector("#bugtracker-screenshot-consent");e&&(e.style.display="block",e.scrollIntoView({behavior:"smooth",block:"center"}))})}handleAllowConsent(){return E(this,void 0,void 0,function*(){var t,e,n;this.screenshotAllowed=!0;const s=null===(t=this.content)||void 0===t?void 0:t.querySelector("#bugtracker-remember-consent");if(!(!s||!s.checked))try{sessionStorage.setItem(this.rememberConsentKey,"1")}catch(t){console.debug("[BugTracker] Could not persist screenshot consent:",t)}const i=null===(e=this.content)||void 0===e?void 0:e.querySelector("#bugtracker-screenshot-consent");i&&(i.style.display="none");try{yield this.captureScreenshot()}catch(t){const e=null===(n=this.content)||void 0===n?void 0:n.querySelector("#bugtracker-screenshot-consent-error");e&&(e.style.display="block",e.textContent="Screenshot capture failed. You can still submit without a screenshot.")}})}handleDenyConsent(){var t;this.screenshotAllowed=!1;const e=null===(t=this.content)||void 0===t?void 0:t.querySelector("#bugtracker-screenshot-consent");e&&(e.style.display="none"),this.showError("Screenshot denied. You can still submit the report without a screenshot.")}updatePreviewElement(t,e){if(!t)return;t.innerHTML="";const n=document.createElement("img");n.src=e,n.alt="Screenshot preview",t.appendChild(n)}showPreviewError(t,e){console.error("Preview capture error:",e),t&&(t.textContent="Failed to capture preview"),this.showError("Failed to capture preview screenshot")}showScreenshotError(t,e){console.error("Screenshot error:",e),t.textContent="Failed to capture screenshot",this.showError("Failed to capture screenshot")}showError(t){var e;const n=null===(e=this.content)||void 0===e?void 0:e.querySelector(".bugtracker-error");n&&(n.textContent=t,n.style.display="block",setTimeout(()=>{n.style.display="none"},5e3))}}var x=function(t,e,n,s){return new(n||(n=Promise))(function(i,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(r,a)}c((s=s.apply(t,e||[])).next())})};class I{constructor(t){this.maxPayloadSize=64e3,this.baseUrl=t.replace(/\/$/,"")}sendEvents(t){if(!navigator.sendBeacon)return console.warn("Beacon API is not supported in this browser"),!1;const e=JSON.stringify(t);if(this.getPayloadSize(e)>this.maxPayloadSize)return console.warn("Payload too large for Beacon API, truncating events"),this.sendTruncatedEvents(t);const n=`${this.baseUrl}/api/events`,s=new Blob([e],{type:"application/json"});return navigator.sendBeacon(n,s)}sendBugReport(t){return x(this,void 0,void 0,function*(){if(!navigator.sendBeacon)return console.warn("Beacon API is not supported in this browser"),!1;const e=yield this.processBugReportPayload(t),n=`${this.baseUrl}/api/reports`,s=new Blob([JSON.stringify(e)],{type:"application/json"});return navigator.sendBeacon(n,s)})}sendBugReportMultipart(t,e){return x(this,void 0,void 0,function*(){const n=`${this.baseUrl}/api/reports`;try{const s=new FormData;s.append("report",new Blob([JSON.stringify(t)],{type:"application/json"})),e&&s.append("screenshot",e,"screenshot.jpg");return(yield fetch(n,{method:"POST",body:s})).ok}catch(t){return console.error("Failed to send bug report:",t),!1}})}sendHeartbeat(t,e){if(!navigator.sendBeacon)return!1;const n={sessionId:t,projectId:e,timestamp:(new Date).toISOString(),url:window.location.href},s=`${this.baseUrl}/api/sessions/heartbeat`,i=new Blob([JSON.stringify(n)],{type:"application/json"});return navigator.sendBeacon(s,i)}processBugReportPayload(t){return x(this,void 0,void 0,function*(){if(t.screenshot&&t.screenshot.length>5e5){console.warn("Screenshot too large for Beacon API, compressing");const e=yield this.compressImage(t.screenshot,.5);return e?Object.assign(Object.assign({},t),{screenshot:e,additionalInfo:Object.assign(Object.assign({},t.additionalInfo),{screenshotCompressed:!0,originalSize:t.screenshot.length,compressedSize:e.length})}):Object.assign(Object.assign({},t),{screenshot:"",additionalInfo:Object.assign(Object.assign({},t.additionalInfo),{screenshotRemoved:!0,reason:"Too large for transmission"})})}return t})}sendTruncatedEvents(t){const e=[...t.events].sort((t,e)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime()).slice(0,10),n=Object.assign(Object.assign({},t),{events:e,truncated:!0,originalEventCount:t.events.length,truncatedEventCount:e.length}),s=`${this.baseUrl}/api/events`,i=new Blob([JSON.stringify(n)],{type:"application/json"});return navigator.sendBeacon(s,i)}compressImage(t){return x(this,arguments,void 0,function*(t,e=.5){return new Promise(n=>{const s=new Image;s.onload=()=>{const t=document.createElement("canvas"),i=t.getContext("2d");if(!i)return void n(null);const o=.5*s.width,r=.5*s.height;t.width=o,t.height=r,i.drawImage(s,0,0,o,r);const a=t.toDataURL("image/jpeg",e);n(a)},s.onerror=()=>{n(null)},s.src=t})})}getPayloadSize(t){return new Blob([t]).size}static isAvailable(){return"undefined"!=typeof navigator&&"sendBeacon"in navigator&&"function"==typeof navigator.sendBeacon}getMaxPayloadSize(){const t=navigator.userAgent.toLowerCase();return t.includes("chrome")||t.includes("firefox")||t.includes("safari")||t.includes("edge")?65536:64e3}testConnection(){return new Promise(t=>{if(!navigator.sendBeacon)return void t(!1);const e={test:!0,timestamp:(new Date).toISOString()},n=`${this.baseUrl}/api/test`,s=new Blob([JSON.stringify(e)],{type:"application/json"});t(navigator.sendBeacon(n,s))})}}var C=function(t,e,n,s){return new(n||(n=Promise))(function(i,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(r,a)}c((s=s.apply(t,e||[])).next())})};class N{constructor(t){if(this.networkMonitor=null,this.userActionTracker=null,this.flushTimer=null,this.isInitialized=!1,void 0===t.projectId||null===t.projectId)throw new Error("projectId is required");if(!t.apiUrl)throw new Error("apiUrl is required");if(this.config=Object.assign({maxBufferSize:50,flushInterval:5e3,captureUserActions:!0,captureNetworkErrors:!0,buttonPosition:"bottom-right",sessionTimeout:18e5,debug:!1},t),this.client=new i(this.config.apiUrl,this.config.projectId),this.beaconClient=new I(this.config.apiUrl),this.sessionManager=new c(this.config.sessionTimeout,this.client),void 0!==this.config.sessionId&&null!==this.config.sessionId){const t=Number(this.config.sessionId);Number.isNaN(t)||this.sessionManager.setServerSessionId(t)}this.eventBuffer=new d(this.config.maxBufferSize,this.flushEvents.bind(this)),this.errorCatcher=new h((t,e)=>this.trackJSError(t,e)),this.config.captureNetworkErrors&&(this.networkMonitor=new m(t=>this.trackNetworkError(t))),this.config.captureUserActions&&(this.userActionTracker=new y(t=>this.trackUserAction(t))),this.widgetButton=new w(this.config.buttonPosition,()=>this.openBugReport())}initialize(){return C(this,void 0,void 0,function*(){var t,e;if(!this.isInitialized)try{let n,s;this.config.debug&&console.log("[BugTracker] initializing session...");try{n=this.sessionManager.initialize(),s=this.sessionManager.getSessionData(),this.config.debug&&console.log("[BugTracker] session initialized:",n)}catch(t){throw console.error("[BugTracker] SessionManager.initialize() failed:",t),new Error(`Session initialization failed: ${t instanceof Error?t.message:String(t)}`)}this.config.debug&&console.log("[BugTracker] starting trackers...");try{this.errorCatcher.start(),null===(t=this.networkMonitor)||void 0===t||t.start(),null===(e=this.userActionTracker)||void 0===e||e.start(),this.config.debug&&console.log("[BugTracker] trackers started")}catch(t){throw console.error("[BugTracker] Starting trackers failed:",t),new Error(`Starting trackers failed: ${t instanceof Error?t.message:String(t)}`)}this.config.debug&&console.log("[BugTracker] creating widget button...");try{this.widgetButton.create(),this.config.debug&&console.log("[BugTracker] widget button created")}catch(t){throw console.error("[BugTracker] WidgetButton.create() failed:",t),new Error(`Widget creation failed: ${t instanceof Error?t.message:String(t)}`)}this.config.debug&&console.log("[BugTracker] starting flush timer...");try{this.startFlushTimer(),this.config.debug&&console.log("[BugTracker] flush timer started (if configured)")}catch(t){throw console.error("[BugTracker] startFlushTimer() failed:",t),new Error(`startFlushTimer failed: ${t instanceof Error?t.message:String(t)}`)}this.config.debug&&console.log("[BugTracker] setting up unload handler...");try{this.setupPageUnloadHandler(),this.config.debug&&console.log("[BugTracker] unload handler set")}catch(t){throw console.error("[BugTracker] setupPageUnloadHandler() failed:",t),new Error(`setupPageUnloadHandler failed: ${t instanceof Error?t.message:String(t)}`)}this.isInitialized=!0,this.config.debug&&console.log("BugTracker initialized")}catch(t){throw console.error("BugTracker initialization failed:",t),t}})}trackJSError(t,e){const n=null==e?void 0:e.event,s={type:"ERROR",name:t.name,message:t.message,stackTrace:t.stack,timestamp:(new Date).toISOString(),url:window.location.href,lineNumber:null==n?void 0:n.lineno,columnNumber:null==n?void 0:n.colno,fileName:null==n?void 0:n.filename,customMetadata:{errorType:"JS_ERROR",errorSource:null==e?void 0:e.type}};this.addEvent(s)}trackNetworkError(t){const e={type:"NETWORK",name:`Network ${t.status}`,message:t.error?t.error.message:void 0,timestamp:(new Date).toISOString(),url:window.location.href,networkUrl:t.url,statusCode:t.status,duration:t.duration,customMetadata:Object.assign({method:t.method},t.error&&{errorName:t.error.name,errorStack:t.error.stack,statusText:t.statusText})};this.addEvent(e)}trackUserAction(t){var e,n;const s=t.element,i={};try{s instanceof HTMLAnchorElement&&(i.href=s.href,s.target&&(i.target=s.target)),s instanceof HTMLFormElement&&(i.action=s.action,i.method=s.method),(s instanceof HTMLInputElement||s instanceof HTMLTextAreaElement||s instanceof HTMLSelectElement)&&(i.inputName=s.name||void 0,i.inputType=s.type||void 0,i.value=(null!==(e=s.value)&&void 0!==e?e:"").toString().substring(0,100)),s.dataset&&Object.keys(s.dataset).length>0&&(i.dataset=Object.assign({},s.dataset))}catch(t){console.debug("[BugTracker] Failed to extract element attributes for action metadata:",t)}const o={type:"ACTION",name:`User ${t.type}`,timestamp:(new Date).toISOString(),url:window.location.href,tagName:s.tagName,xPath:this.getElementXPath(s),customMetadata:Object.assign({elementId:s.id||void 0,elementClass:s.className||void 0,textContent:null===(n=s.textContent)||void 0===n?void 0:n.substring(0,100),eventType:t.event.type},i)};this.addEvent(o)}trackEvent(t,e){const n={type:"CUSTOM",name:t,timestamp:(new Date).toISOString(),url:window.location.href,customMetadata:e};this.addEvent(n)}captureError(t,e){const n={type:"ERROR",name:t.name,message:t.message,stackTrace:t.stack,timestamp:(new Date).toISOString(),url:window.location.href,customMetadata:Object.assign(Object.assign({},e),{capturedManually:!0})};this.addEvent(n)}addEvent(t){this.eventBuffer.add(t)}flushEvents(t){return C(this,void 0,void 0,function*(){if(0!==t.length)try{const e=yield this.client.sendEvents(t,this.sessionManager.getSessionId(),this.sessionManager.getSessionData());this.config.debug&&console.log(`Flushed ${t.length} events:`,e)}catch(t){throw console.error("Failed to flush events:",t),t}})}openBugReport(){return C(this,void 0,void 0,function*(){const t=Number(this.sessionManager.getSessionId()),e=String(this.config.projectId),n=new T(this.beaconClient,e,t,()=>C(this,void 0,void 0,function*(){yield this.eventBuffer.flush(),this.trackEvent("BugReportSubmitted",{});try{yield this.eventBuffer.flush()}catch(t){console.error("[BugTracker] Failed to flush events after BugReportSubmitted:",t)}try{this.config.debug&&console.log("[BugTracker] ending current session after report..."),this.sessionManager.endSession()}catch(t){console.error("[BugTracker] Failed to end session after report:",t)}try{this.config.debug&&console.log("[BugTracker] creating new session after report...");const t=this.sessionManager.initialize();this.config.debug&&console.log("[BugTracker] new session id:",t)}catch(t){console.error("[BugTracker] Failed to create a new session after report:",t)}this.config.debug&&console.log("Bug report sent successfully")}));yield n.open()})}startFlushTimer(){this.flushTimer&&clearInterval(this.flushTimer),this.config.flushInterval&&this.config.flushInterval>0&&(this.flushTimer=window.setInterval(()=>{this.eventBuffer.flush()},this.config.flushInterval)),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.eventBuffer.hasUrgentEvents()&&this.eventBuffer.flush().catch(()=>{})})}setupPageUnloadHandler(){window.addEventListener("beforeunload",()=>{const t=this.eventBuffer.getEvents();this.eventBuffer.hasUrgentEvents()&&t.length>0&&this.client.sendEventsWithBeacon(t,this.sessionManager.getSessionId(),this.sessionManager.getSessionData())})}getElementXPath(t){var e;if(t.id)return`//*[@id="${t.id}"]`;const n=[];let s=t;for(;s&&s.nodeType===Node.ELEMENT_NODE;){let t=0;const i=(null===(e=s.parentNode)||void 0===e?void 0:e.children)||[];for(let e=0;e<i.length;e++){if(i[e]===s){n.unshift(`${s.tagName.toLowerCase()}[${t+1}]`);break}i[e].tagName===s.tagName&&t++}s=s.parentElement}return n.length?"/"+n.join("/"):""}destroy(){var t,e;this.flushTimer&&(clearInterval(this.flushTimer),this.flushTimer=null),this.errorCatcher.stop(),null===(t=this.networkMonitor)||void 0===t||t.stop(),null===(e=this.userActionTracker)||void 0===e||e.stop(),this.widgetButton.destroy(),window.removeEventListener("beforeunload",this.eventBuffer.flush),document.removeEventListener("visibilitychange",this.eventBuffer.flush),this.isInitialized=!1}getSessionId(){return this.sessionManager.getSessionId()}flush(){return C(this,void 0,void 0,function*(){yield this.eventBuffer.flush()})}waitForServerSession(){return C(this,arguments,void 0,function*(t=5e3){const e=Date.now();return new Promise(n=>{const s=()=>{this.sessionManager.isServerBacked()?n(this.sessionManager.getSessionId()):Date.now()-e>=t?n(null):setTimeout(s,200)};s()})})}ensureServerSession(){return C(this,void 0,void 0,function*(){if(!this.client)return null;try{const t=this.sessionManager.getSessionId(),e=this.sessionManager.getSessionData();console.debug("[BugTracker] ensureServerSession: sending POST to /api/sessions for local id",t);const n=yield this.client.sendSessionStart(String(t),e);return null===n||Number.isNaN(Number(n))?(console.debug("[BugTracker] ensureServerSession: server did not return a session id"),null):(this.sessionManager.setServerSessionId(Number(n)),console.debug("[BugTracker] ensureServerSession: server session created",n),Number(n))}catch(t){return console.error("[BugTracker] ensureServerSession failed:",t),null}})}}var B=function(t,e,n,s){return new(n||(n=Promise))(function(i,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(r,a)}c((s=s.apply(t,e||[])).next())})};let O=null,A=null,R=null;const j=()=>{if(!O&&!A)throw new Error("BugTracker not initialized. Call BugTracker.initialize(projectId, opts) first.")},M={initialize(t,e){return B(this,void 0,void 0,function*(){var n;if(R)return R;if(A)return Promise.resolve(M);const s=null!==(n=null==e?void 0:e.baseUrl)&&void 0!==n?n:window.location.origin;O=new i(s,String(t));try{A=new N({projectId:String(t),apiUrl:s,debug:!!(null==e?void 0:e.debug)})}catch(t){throw console.error("[BugTracker] Failed to construct tracker:",t),t}return R=A.initialize().then(()=>M).catch(t=>{throw console.error("[BugTracker] initialization failed:",t),R=null,t}),R})},sendEvents(t,e,n){return B(this,void 0,void 0,function*(){if(j(),O)return O.sendEvents(t,e,n);throw new Error("Client not available")})},sendEventsWithBeacon:(t,e,n)=>(j(),!!O&&O.sendEventsWithBeacon(t,e,n)),sendBugReport(t,e,n){return B(this,void 0,void 0,function*(){if(j(),O)return O.sendBugReport(t,e,n);throw new Error("Client not available")})},isInitialized:()=>null!==O||null!==A};if("undefined"!=typeof window)try{window.BugTracker=M}catch(t){console.debug("[BugTracker] Could not attach global BugTracker:",t)}M.initialize,M.sendEvents,M.sendEventsWithBeacon,M.sendBugReport,M.isInitialized;const D=M;return n=n.default})());